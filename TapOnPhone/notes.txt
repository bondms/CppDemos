void ProcessRequest(const ThreadData& item)
{
  json request = Read(item);
  Handler handler = SelectHandler(request);
  json response = handler(request);
  Send(response);
}

using Handler = std::function<json(const json& request)>;

===

// Unit test to confirm ordered.
OrderedHandlers
{
  {1, "Ping", PingHandler},
  {100, "Trial", TrialHandler},
}

Handler SelectHandler(const json& request)
{
  return binary_search(OrderedHandlers, commandId).HandlerFunc;
}

=== Trial ===

struct TrialRequest {...};
struct TrialResponse {...};

json TrialHandler(const json& request)
{
  TrialRequest trial_request = parse_trial(request);
  TrialResponse trial_response{};
  try
  {
    trial_response = trial_function(trial_request);
  }
  catch ( const ProcessingError& e)
  {
    trial_response.error_info = extract_info(e);
  }
  return build_trial_json(trail_response);
}

// Unit testable.
TrialRequest parse_trial(const json& request)
{
  ...
}

// Unit testable.
TrialResponse trial_function(const TrialRequest& trial_request)
{
  ...
}

// Unit testable.
json build_trial_json(const TrialResponse& trial_response)
{
  ...
}

===
